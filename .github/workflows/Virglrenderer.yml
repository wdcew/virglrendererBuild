name: Build Virglrenderer for Unraid

on:
  workflow_dispatch: # 允许手动点击按钮触发

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: andy5995/slackware-build-essential:15.0 # 使用与 Unraid 6.12 相同的底包
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          # 1. 配置镜像源并更新包索引
          echo "--> Configuring mirrors and updating package lists..."
          sed -i 's|# http://mirrors.slackware.com/slackware/slackware64-15.0/|http://mirrors.slackware.com/slackware/slackware64-15.0/|' /etc/slackpkg/mirrors
           # 2. 【关键修复】关闭 GPG 校验
          # 在一次性 CI 环境中，为了避免密钥过期导致构建失败，直接关闭校验
          sed -i 's/CHECKGPG=on/CHECKGPG=off/' /etc/slackpkg/slackpkg.conf
          sed -i 's/POSTINST=on/POSTINST=off/' /etc/slackpkg/slackpkg.conf
          
          # [基础编译工具]
          # bison/flex: Mesa 编译必须的词法分析工具
          # expat/pkg-config: 基础库查找工具
          #slackpkg -batch=on -default_answer=y install \
            #git python3 gcc make binutils glibc pkg-config \
            #guile gc kernel-headers expat bison flex

          # [网络与 Git 依赖] 
          # 修复 git clone 报错 (缺 libbrotli, nghttp2 等)
          slackpkg -batch=on -default_answer=y install \
            #nghttp2 libpsl libssh2 cyrus-sasl ca-certificates \
            #brotli zstd libidn2

          # [X11 与 OpenGL 基础]
          # libglvnd: 提供 gl.pc, egl.pc
          # libX*: 提供 OpenGL 编译所需的窗口系统头文件
          # libxshmfence: Mesa 必须的共享内存库
          slackpkg -batch=on -default_answer=y install \
            libglvnd libX11 libXext libXfixes libxcb \
            libXau libXdmcp libxshmfence libvdpau

          # [图形核心库与 Wayland]
          # vulkan-sdk: 编译 Venus (Vulkan) 必须
          # wayland-protocols: 编译 Mesa Wayland 支持必须
          # libdrm/libepoxy/libva/mesa: 虽然我们会编译新版，但先装旧版作为构建依赖
          slackpkg -batch=on -default_answer=y install \
            libdrm libepoxy libva mesa vulkan-sdk \
            wayland wayland-protocols

          # [LLVM 与 Clang]
          # 编译 Mesa 的 AMD (radeonsi) 和 Intel (iris) 驱动必须依赖 LLVM
          slackpkg -batch=on -default_answer=y install \
            #llvm libxml2 zlib \
            
             
          # 4. 安装 Python 构建工具
          # Mako 是 Mesa 编译必须的模板引擎
          python3 -m ensurepip
          pip3 install meson ninja mako

      - name: Clone Virglrenderer
        run: |
          git clone https://gitlab.freedesktop.org/virgl/virglrenderer.git
          cd virglrenderer
          # 你可以在这里 git checkout 某个特定的 commit，如果 HEAD 编译失败

      - name: Build and Package
        run: |
          cd virglrenderer
          
          # 配置 Meson，开启视频支持
          meson setup build \
            -Dprefix=/usr \
            -Dlibdir=lib64 \
            -Dvenus=true \
            -Dvideo=true \
            -Dbuildtype=release

          # 编译
          cd build
          ninja

          # 伪安装到临时目录
          mkdir -p pkg
          DESTDIR=$(pwd)/pkg ninja install

          # 制作 Slackware 安装包
          cd pkg
          # 使用 makepkg 制作 txz
          # 注意：chown 是为了防止 GitHub Action 的权限问题，但在容器内通常是 root
          makepkg -l y -c n ../../../virglrenderer-video-unraid-x86_64.txz

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: virglrenderer-package
          path: virglrenderer-video-unraid-x86_64.txz
