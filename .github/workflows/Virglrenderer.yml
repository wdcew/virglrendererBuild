name: Build Virglrenderer for Unraid

on:
  workflow_dispatch: # 允许手动点击按钮触发

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: aclemons/slackware:15.0 # 使用与 Unraid 6.12 相同的底包
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          # 1. 配置镜像源并更新包索引
          echo "--> Configuring mirrors and updating package lists..."
          sed -i 's|# http://mirrors.slackware.com/slackware/slackware64-15.0/|http://mirrors.slackware.com/slackware/slackware64-15.0/|' /etc/slackpkg/mirrors
           # 2. 【关键修复】关闭 GPG 校验
          # 在一次性 CI 环境中，为了避免密钥过期导致构建失败，直接关闭校验
          sed -i 's/CHECKGPG=on/CHECKGPG=off/' /etc/slackpkg/slackpkg.conf
          sed -i 's/POSTINST=on/POSTINST=off/' /etc/slackpkg/slackpkg.conf
          
          slackpkg -batch=on -default_answer=y update
          # 这一步会更新 expat, glibc, openssl 等所有基础库，解决版本不匹配问题
          slackpkg -batch=on -default_answer=y upgrade-all
          # 2. 核心步骤：单独安装 Python3 并立即验证
          echo "--> Installing Python3..."
          slackpkg -batch=on -default_answer=y install python3
          
          echo "--> Verifying Python3 installation..."
          which python3 || (echo "Python3 not found after installation!"; exit 1)
          python3 --version

          # 3. 安装其余的编译工具和依赖库
          echo "--> Installing build tools and libraries..."
          slackpkg -batch=on -default_answer=y install git gcc make binutils pkg-config \
             libdrm libepoxy libva mesa kernel-headers expat

          # 4. 使用已验证的 Python3 安装 Meson 和 Ninja
          echo "--> Installing Meson and Ninja via pip..."
          python3 -m ensurepip --upgrade
          pip3 install meson ninja

          echo "--> All dependencies installed successfully."

      - name: Clone Virglrenderer
        run: |
          git clone https://gitlab.freedesktop.org/virgl/virglrenderer.git
          cd virglrenderer
          # 你可以在这里 git checkout 某个特定的 commit，如果 HEAD 编译失败

      - name: Build and Package
        run: |
          cd virglrenderer
          
          # 配置 Meson，开启视频支持
          meson setup build \
            -Dprefix=/usr \
            -Dlibdir=lib64 \
            -Dvenus=true \
            -Dvideo=true \
            -Dbuildtype=release

          # 编译
          cd build
          ninja

          # 伪安装到临时目录
          mkdir -p pkg
          DESTDIR=$(pwd)/pkg ninja install

          # 制作 Slackware 安装包
          cd pkg
          # 使用 makepkg 制作 txz
          # 注意：chown 是为了防止 GitHub Action 的权限问题，但在容器内通常是 root
          makepkg -l y -c n ../../../virglrenderer-video-unraid-x86_64.txz

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: virglrenderer-package
          path: virglrenderer-video-unraid-x86_64.txz
